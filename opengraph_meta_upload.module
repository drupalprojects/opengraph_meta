<?php
/**
 * @file
 * Adds an image upload field to the open graph meta tags field set.
 */

function opengraph_meta_upload_form_alter(&$form, &$form_state, $form_id) {
  // if editing a node
  if ('node_form' == stristr($form_id, 'node_form')) {
	if (!isset($form['opengraph_meta_image'])) {
		return;
	}
	if (!isset($form['opengraph_meta'])) {
		return;
    }

	// Move the opengraph_meta_image field into the opengraph_meta fieldset
	$upload_field = $form['opengraph_meta_image'];
	unset($form['opengraph_meta_image']);
	unset($upload_field['#weight']);
	$form['opengraph_meta']['opengraph_meta_image'] = $upload_field;

    // Add our submit handler
	$form['#submit'][] = 'opengraph_meta_image_node_form_submit';
  }
}

/**
 * Inserts the URI of the uploaded image into opengraph_meta's image field
 */
function opengraph_meta_image_node_form_submit(&$form, &$form_state) {
	$upload_field = $form['opengraph_meta']['opengraph_meta_image'];
	unset($form['opengraph_meta']['opengraph_meta_image']);
	$form['opengraph_meta_image'] = $upload_field;

	$upload_field = $form_state['values']['opengraph_meta']['opengraph_meta_image'];
	unset($form_state['values']['opengraph_meta']['opengraph_meta_image']);
	$form_state['values']['opengraph_meta_image'] = $upload_field;
}

